检测到NVIDIA CUDA 后端可用，将使用 'cuda' 设备。
CPU设备将用于对比场景：'cpu'
实验配置: 模型=gpt2, 并发数=100, 输入长度约=512, 生成长度=512

--- 正在加载资源 ---
为设备 'cuda' 加载模型...
为设备 'cpu' 加载模型...
输入数据准备完成。每个请求实际输入token数: 512, 总输入: 51200 tokens
目标生成token总数: 51200 tokens
------------------------------
NVIDIA CUDA GPU活动监控提示:
此脚本不包含自动GPU利用率跟踪。您可以通过以下方式手动观察：
1. 在终端运行: nvidia-smi
2. 或更动态地: watch -n 0.1 nvidia-smi
请在脚本的关键阶段（如模型生成时）观察GPU活动和显存使用。
------------------------------

--- 正在进行设备预热 ---
cuda 设备预热完成。
cpu 设备预热完成。

--- 开始正式测试 ---

场景 A: Prefill on cuda, Decode on cuda (All-GPU)
提示 (场景 A): 请手动开始观察CUDA GPU活动 (nvidia-smi)。
提示 (场景 A): 请手动结束观察CUDA GPU活动。
  Prefill耗时: 0.8322s, 吞吐量: 61525.23 t/s
  Decode耗时: 22.3081s, 吞吐量: 2295.13 t/s (生成51200 tokens)

场景 C: Prefill on cuda, Decode on cpu (PD-Split)
提示 (场景 C Prefill): 请手动开始观察CUDA GPU活动 (nvidia-smi)。
提示 (场景 C Prefill): 请手动结束观察CUDA GPU活动。
  正在将KV Cache从 cuda 转移到 cpu...
  KV Cache转移耗时: 1.2511 秒
  Prefill (cuda)耗时: 0.7970s, 吞吐量: 64239.91 t/s
  Decode (cpu)耗时: 98.5187s, 吞吐量: 519.70 t/s (生成51200 tokens)

场景 B: Prefill on cpu, Decode on cpu (All-CPU)
  Prefill耗时: 5.3853s, 吞吐量: 9507.44 t/s
  Decode耗时: 156.6371s, 吞吐量: 326.87 t/s (生成51200 tokens)

--- 实验结果汇总统计 ---
模型: gpt2, 并发数: 100, 输入长度/请求: 512, 生成长度/请求: 512
总输入Tokens: 51200, 目标总生成Tokens: 51200
-----------------------------------------------------------------------------------------------------------------------------
场景描述                      | Prefill Time (s)   | Prefill Tput (t/s)   | KV Tx Time (s)  | Decode Time (s)    | Decode Tput (t/s)    | Total Time (s)     | Overall Tput (t/s)  
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All-cuda                  | 0.8322             | 61525.23             | 0.0000          | 22.3081            | 2295.13              | 23.1403            | 4425.18             
P(cuda)-D(cpu)            | 0.7970             | 64239.91             | 1.2511          | 98.5187            | 519.70               | 100.5668           | 1018.23             
All-cpu                   | 5.3853             | 9507.44              | 0.0000          | 156.6371           | 326.87               | 162.0223           | 632.01              
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

分析提示:
  - Prefill Tput: 输入tokens处理速度。GPU通常远高于CPU。
  - Decode Tput: 新生成tokens的速度。比较不同设备/策略下的Decode效率。
  - KV Tx Time: 在PD分离且跨设备时，KV Cache的转移开销。
  - Overall Tput: (总输入tokens + 总生成tokens) / 总耗时。衡量端到端效率。

实验结束。